#!/bin/bash
# run-container-dotme $IMAGE <hostdir>:<containerdir>
set -euo pipefail

# Check if correct number of arguments provided
if [ $# -ne 2 ]; then
  echo "Usage: $0 <IMAGE> <hostdir>:<containerdir>"
  echo "Example: $0 my-image:latest /Users/me/project:/workspace"
  exit 1
fi

# Parse arguments
IMAGE_NAME="$1"
MOUNT_SPEC="$2"

# Parse the mount specification
if [[ "$MOUNT_SPEC" =~ ^([^:]+):(.+)$ ]]; then
  HOST_WORKSPACE="${BASH_REMATCH[1]}"
  CONTAINER_WORKSPACE="${BASH_REMATCH[2]}"
else
  echo "Error: Invalid mount specification. Use format: hostdir:containerdir"
  echo "Example: /Users/me/project:/workspace"
  exit 1
fi

# Validate paths
if [ ! -d "$HOST_WORKSPACE" ]; then
  echo "Error: Host directory '$HOST_WORKSPACE' does not exist"
  exit 1
fi

# Parse image name to extract repository and tag/version
# Example: docker.io/redis/redis:1.2.3 -> repo=redis, tag=1.2.3
# Example: nginx:latest -> repo=nginx, tag=latest
if [[ "$IMAGE_NAME" =~ ^([^:]+):(.+)$ ]]; then
  REPO_NAME="${BASH_REMATCH[1]}"
  TAG_VERSION="${BASH_REMATCH[2]}"
else
  # If no tag specified, use 'latest'
  REPO_NAME="$IMAGE_NAME"
  TAG_VERSION="latest"
fi

# Extract just the repository name (remove registry and path)
# Example: docker.io/redis/redis -> redis
# Example: nginx -> nginx
if [[ "$REPO_NAME" =~ /([^/]+)$ ]]; then
  REPO_BASENAME="${BASH_REMATCH[1]}"
else
  REPO_BASENAME="$REPO_NAME"
fi

# Generate container name in format: runcontainerdotme-tag-version
CONTAINER_NAME="runcontainerdotme-${REPO_BASENAME}-${TAG_VERSION}"
DOCKER_CLI=${RUN_CONTAINER_DOCKER_CLI:-docker}

# Check if the container exists and remove it safely
if ${DOCKER_CLI} ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
  echo "Stopping and removing existing container: $CONTAINER_NAME"
  ${DOCKER_CLI} kill "$CONTAINER_NAME" >/dev/null 2>&1 || echo "Container not running"
  ${DOCKER_CLI} rm "$CONTAINER_NAME" >/dev/null 2>&1 || echo "Failed to remove container"
fi

# Run the container
echo "Starting container: $CONTAINER_NAME"
echo "Image: $IMAGE_NAME"
echo "Mount: $HOST_WORKSPACE -> $CONTAINER_WORKSPACE"

# Prepare proxy environment variables
PROXY_ENV=""
if [ -n "${http_proxy:-}" ]; then
  PROXY_ENV="$PROXY_ENV -e http_proxy=$http_proxy"
fi
if [ -n "${https_proxy:-}" ]; then
  PROXY_ENV="$PROXY_ENV -e https_proxy=$https_proxy"
fi
if [ -n "${HTTP_PROXY:-}" ]; then
  PROXY_ENV="$PROXY_ENV -e HTTP_PROXY=$HTTP_PROXY"
fi
if [ -n "${HTTPS_PROXY:-}" ]; then
  PROXY_ENV="$PROXY_ENV -e HTTPS_PROXY=$HTTPS_PROXY"
fi
if [ -n "${no_proxy:-}" ]; then
  PROXY_ENV="$PROXY_ENV -e no_proxy=$no_proxy"
fi
if [ -n "${NO_PROXY:-}" ]; then
  PROXY_ENV="$PROXY_ENV -e NO_PROXY=$NO_PROXY"
fi

${DOCKER_CLI} run -d --network host --name "$CONTAINER_NAME" \
  -v "$HOST_WORKSPACE":"$CONTAINER_WORKSPACE" \
  $PROXY_ENV \
  "$IMAGE_NAME" tail -f /dev/null

echo "Container $CONTAINER_NAME started successfully."
echo "To connect: ${DOCKER_CLI} exec -it $CONTAINER_NAME /bin/bash"
